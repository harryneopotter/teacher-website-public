#!/bin/bash
# Pre-commit hook to prevent committing sensitive data
# To install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit security checks..."

# Check if gitleaks is installed
if command -v gitleaks &> /dev/null; then
    echo "Running gitleaks scan..."
    if gitleaks protect --verbose --redact --staged --config .gitleaks.toml; then
        echo "‚úÖ Gitleaks scan passed"
    else
        echo "‚ùå Gitleaks found potential secrets!"
        echo "Please review the findings above and remove sensitive data before committing."
        echo "If this is a false positive, add it to .gitleaks.toml allowlist."
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Warning: gitleaks not installed. Install with:"
    echo "  brew install gitleaks  # macOS"
    echo "  or download from https://github.com/gitleaks/gitleaks"
fi

# Check for common sensitive patterns
echo "Running basic pattern checks..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check."
    exit 0
fi

# Patterns to check
PATTERNS=(
    "password\s*=\s*['\"][^'\"]{3,}"
    "api[_-]?key\s*=\s*['\"][^'\"]{10,}"
    "secret\s*=\s*['\"][^'\"]{10,}"
    "token\s*=\s*['\"][^'\"]{20,}"
    "[0-9]{8,10}:[a-zA-Z0-9_-]{35,}"  # Telegram bot token
    "-----BEGIN .*PRIVATE KEY-----"
    "sk_live_[a-zA-Z0-9]{20,}"  # Stripe live key
    "AIza[0-9A-Za-z-_]{35}"  # Google API key
)

FOUND_ISSUE=false

for pattern in "${PATTERNS[@]}"; do
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Skip documentation files and examples
            if [[ "$file" =~ \.md$ ]] || [[ "$file" =~ example ]] || [[ "$file" =~ GUIDE ]]; then
                continue
            fi
            
            if grep -qiE "$pattern" "$file"; then
                echo "‚ö†Ô∏è  Potential sensitive data in $file"
                echo "   Pattern: $pattern"
                FOUND_ISSUE=true
            fi
        fi
    done
done

if [ "$FOUND_ISSUE" = true ]; then
    echo ""
    echo "‚ùå Potential sensitive data detected in staged files!"
    echo "Please review the warnings above and ensure no secrets are being committed."
    echo "To bypass this check (not recommended): git commit --no-verify"
    exit 1
fi

echo "‚úÖ Basic security checks passed"
exit 0
